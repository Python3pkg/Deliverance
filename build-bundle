#!/bin/sh

fail () {
    echo "$@"
    exit 1
}

REV=$(python -c 'import pyinstall; print pyinstall.get_svn_revision(".")')
FILE="Deliverance-snapshot-r${REV}.pybundle"

if [ -e "$FILE" ] ; then
    echo "Bundle file $FILE already exists"
    exit 0
fi

echo "CREATING BUNDLE: $FILE"
echo

## httplib2 location is a temporary problem with a bad pypi entry
pyinstall.py --bundle=$FILE --build=build-bundle-files/ --src=src-bundle-files/ \
  http://httplib2.googlecode.com/files/httplib2-0.4.0.tar.gz \
  -e svn+http://codespeak.net/svn/z3/deliverance/trunk#egg=Deliverance \
  supervisord PasteScript
  || fail 'Bundle failed'

echo 'INSTALLING'
echo

rm -rf TEST
pyinstall.py -E TEST $FILE \
  || fail 'Install failed'

cd TEST/src/deliverance
chmod +x test
./test \
  || fail 'Tests failed'

